/*
 * DSI.c
 *
 *  Created on: Apr 18, 2025
 *      Author: sally
 */

#include <avr/io.h>
#define F_CPU 16000000UL
#include <util/delay.h>
#include <stdlib.h>
#include <math.h>
#define LCD_C_P PORTD //C COMMAND
#define LCD_D_P PORTA //D DATA
#define LCD_C_DDR DDRD
#define LCD_D_DDR DDRA
#define EN 1
#define RW 2
#define RS 0


#define KOUT PORTB
#define KIN PINB
#define KDDR DDRB


void enable (){
	_delay_us(0.5);
	LCD_C_P|=(1<<EN);
	_delay_us(1);
	LCD_C_P&=~(1<<EN);
	_delay_ms(2);
}
void send_D_C (unsigned char a,unsigned char t){
	if(t == 0) //command
		LCD_C_P&=~(1<<RS);
	else if(t == 1) //data
		LCD_C_P|=(1<<RS);
	LCD_C_P&=~(1<<RW);
	LCD_D_P&=0XF0;
	LCD_D_P|=(a>>4);
	enable();
	LCD_D_P&=0XF0;
	LCD_D_P|=(a&0X0F);
	enable();
}

void LCD_X_Y(unsigned char x, unsigned char y){
	if (y==0)
		send_D_C((0X80+x),0);
	else if (y==1)
		send_D_C((0XC0+x),0);
}

void LCD_D_C_ST(unsigned char* s){
	while(*s!='\0'){
		send_D_C(*s,1);
		s++;
	}
}
void LCD_D_C_VAR(unsigned char s){

		send_D_C(s,1);

}

void LCD_INIT1(){
	unsigned char com[] = { 0X33, 0X32, 0X28, 0X0F,0X06,0X80};
	_delay_ms(15);
	for(unsigned char i=0;i<6;i++){
		send_D_C(com[i],0);
	}
}

char get_char(){
	unsigned char C,R,K,a;
	for(unsigned char i =0 ; i<4 ; i++){
		KOUT =(~(1<<i));
		_delay_ms(1);
		C=(KIN&0XF0);
		if(C!=0XF0){
			R=i;
			break;
		}
	}

	for(unsigned char j =4 ; j<8 ; j++){
		K =(~(1<<j)&0xF0);
		if(C==K){
			a =KEY[R][j-4];
			break;
		}
	}
	return a;
}

unsigned char KEY[4][4]={{'/','9','8','7'},
						{'*','6','5','4'},
						{'-','3','2','1'},
						{'+','=','0','o'}};
int main(void){
	unsigned char a;
	unsigned int n1=0,n2=0,i=0;
	KDDR = 0X0F ;
	DDRA = 0XFF;
	while (1) {
		LCD_D_DDR |= 0X0F;
		LCD_C_DDR |= 0X07;
		LCD_INIT1();

		KOUT = 0XF0;

		do
		{
			while((KIN & 0XF0) == 0XF0);
			_delay_ms(1);
		} while ((KIN & 0XF0) == 0XF0);


		do{
			a=get_char();
			LCD_D_C_VAR(a);
			LCD_X_Y(i++, 0);
			n1 = n1*10 + atoi(a);
		}while(a!='+' || a!='-' || a!='*' || a!='+');

		/*while(a!='='){
					}*/

	}
}

